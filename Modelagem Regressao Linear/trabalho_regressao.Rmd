---
title: "teste"
author: "Victor Telles; Felipe Carmo; Leandro Barros"
date: "2023-10-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#rmarkdown::render("/Users/victortelles/Documents/Coursera/Especializacao - UFMG/04 - Modelagem de relacoes usando Regressao Linear/Trabalho/test.Rmd") 
```

```{r dados1, include=FALSE, echo=TRUE}
require(car) # pacote car - para analise de colinearidade entre variavies 
require(rgl) # pacote rgl
require(leaps) # 
require(lmtest) # pacote lmtest
require(olsrr) # pacote olsrr - para analise de dados Outliers
require(dplyr)
require(ggplot2)
require(lubridate)
require(geosphere)
library(tidyverse)
require(corrplot)
require(nortest)

setwd("/Users/victortelles/Documents/Coursera/Especializacao - UFMG/01 - Analise Exploratoria de Dados/Trabalho/Dados")
```
```{r programa}
#dfReview <- read.csv("olist_order_reviews_dataset.csv", sep = ",", header = TRUE)
dfOrder <- read.csv("olist_orders_dataset.csv", sep = ",", header = TRUE)
dfOrderItems <- read.csv("olist_order_items_dataset.csv", sep = ",", header = TRUE)
dfProduct <- read.csv("olist_products_dataset.csv", sep = ",", header = TRUE)
dfSeller <- read.csv("olist_sellers_dataset.csv", sep =",", header = TRUE)
dfCustomer <- read.csv("olist_customers_dataset.csv", sep =",", header = TRUE)
dfGeo <- read.csv("olist_geolocation_dataset.csv", sep = ",", header = TRUE)
dfPay <- read.csv("olist_order_payments_dataset.csv", sep = ",", header = TRUE)

# Agregacao do OrderItems - Max(qty Items), Sum(price), sum (freight_value) - por seller, order_id e product_id
dfOrdersItemsAdj <- dfOrderItems %>% 
  group_by(seller_id, order_id, product_id) %>%                  
  summarise(qty_product = max(order_item_id), total_price = sum(price), total_freight = sum(freight_value)) 

#Agregacao do dfGeo - pegando a media do X e Y 
dfGeoAdj <- dfGeo %>% 
  group_by(geolocation_zip_code_prefix, geolocation_state) %>%
  summarise(across(-geolocation_city, mean, na.rm = TRUE))

#Agregacao do dfGeo - pegando a media do X e Y 
dfPayAdj <- dfPay %>% 
  filter(payment_type == "voucher")
  
## Inicio do cruzamento de bases
df1 <- merge(dfOrdersItemsAdj, dfSeller, by.x = "seller_id", by.y = "seller_id")
df1 <- merge(df1, dfProduct, by.x = "product_id", by.y = "product_id")
df2Aux <- merge(dfOrder, dfCustomer, by.x = "customer_id", by.y = "customer_id")
df1 <- merge(df1, dfGeoAdj, by.x = "seller_zip_code_prefix", by.y = "geolocation_zip_code_prefix")
df1 <- subset(df1, select = -geolocation_state)
colnames(df1)[18] <- "seller_geolocation_lat"
colnames(df1)[19] <- "seller_geolocation_long"

dfPayAdj <- dfPayAdj %>% distinct(order_id, .keep_all = TRUE)
df2Aux <- df2Aux %>% distinct(order_id, .keep_all = TRUE)
df2 <- df2Aux %>% anti_join( dfPayAdj, by='order_id')

df2 <- merge(df2, dfGeoAdj, by.x = "customer_zip_code_prefix", by.y = "geolocation_zip_code_prefix")
df2 <- subset(df2, select = -geolocation_state)
colnames(df2)[13] <- "customer_geolocation_lat"
colnames(df2)[14] <- "customer_geolocation_long"

df <- merge(df2, df1, by.x = "order_id", by.y = "order_id", x.all = TRUE)

#remocao de variaveis
df <- subset(df, select = -product_name_lenght) 
df <- subset(df, select = -product_description_lenght)
df <- subset(df, select = -product_photos_qty)
df <- subset(df, select = -seller_zip_code_prefix)
df <- subset(df, select = -customer_zip_code_prefix)
 
#Filtro de pedidos com status entregue
dfDelivered <- subset(df, order_status == "delivered")

#criacao de variaveis de tempo
dfDelivered$dataPedido <- strptime(dfDelivered$order_purchase_timestamp, "%Y-%m-%d %H:%M:%OS")
dfDelivered$dataAprovacao <- strptime(dfDelivered$order_approved_at, "%Y-%m-%d %H:%M:%OS")
dfDelivered$dataTransporte <- strptime(dfDelivered$order_delivered_carrier_date, "%Y-%m-%d %H:%M:%OS")
dfDelivered$dataEntrega <- strptime(dfDelivered$order_delivered_customer_date, "%Y-%m-%d %H:%M:%OS")
dfDelivered$dataEstimada <- strptime(dfDelivered$order_estimated_delivery_date, "%Y-%m-%d %H:%M:%OS")

dfDelivered$tempoEntrega <- difftime(dfDelivered$dataEntrega, dfDelivered$dataPedido, "UTC", units = "days")
#remocao de variaveis
dfDelivered <- subset(dfDelivered, select = -order_purchase_timestamp) 
dfDelivered <- subset(dfDelivered, select = -order_approved_at)
dfDelivered <- subset(dfDelivered, select = -order_delivered_carrier_date)
dfDelivered <- subset(dfDelivered, select = -order_delivered_customer_date)
dfDelivered <- subset(dfDelivered, select = -order_estimated_delivery_date)

#criacao de variveis de distancia
dfDelivered <- dfDelivered %>%
  mutate(
    dist = geosphere::distHaversine(cbind(seller_geolocation_long, seller_geolocation_lat), cbind(customer_geolocation_long, customer_geolocation_lat))
  )

#remocao de variaveis 
dfDelivered <- subset(dfDelivered, select = -seller_geolocation_long)
dfDelivered <- subset(dfDelivered, select = -seller_geolocation_lat)
dfDelivered <- subset(dfDelivered, select = -customer_geolocation_long)
dfDelivered <- subset(dfDelivered, select = -customer_geolocation_lat)


#dfFinal <- subset(dfFinal, select = -customer_state)
#dfFinal <- subset(dfFinal, select = -customer_city)
#dfFinal <- subset(dfFinal, select = -seller_state)
#dfFinal <- subset(dfFinal, select = -seller_city)
dfFinal <- subset(dfDelivered, select = -customer_id)
dfFinal <- subset(dfFinal, select = -order_status)
dfFinal <- subset(dfFinal, select = -order_id)
dfFinal <- subset(dfFinal, select = -product_id)
dfFinal <- subset(dfFinal, select = -seller_id)

#criando novas variaveis
dfFinal$volume <- dfFinal$product_length_cm * dfFinal$product_height_cm * dfFinal$product_width_cm 
dfFinal$tempoEntregaNum <- as.numeric(dfFinal$tempoEntrega)

#removendo variaveis não numericas
dfNum <- subset(dfFinal, select = -dataAprovacao)
dfNum <- subset(dfNum, select = -dataTransporte)
dfNum <- subset(dfNum, select = -tempoEntrega)
dfNum <- subset(dfNum, select = -dataEntrega)
dfNum <- subset(dfNum, select = -customer_unique_id)
#dfNum <- subset(dfNum, select = -product_category_name)
#dfNum <- subset(dfNum, select = -dataPedido)
#dfNum <- subset(dfNum, select = -dataEstimada)

#novas features - categoricas
dfNum$mes_pedido <- month(dfNum$dataPedido)
dfNum$mes_estima_entrega <- month(dfNum$dataEstimada)


dfNum$periodo_mes_pedido <- ifelse(day(dfNum$dataPedido) <= 5, "inicio do mês", ifelse(day(dfNum$dataPedido) <= 23, "meio do mês", "fim do mês")) 
dfNum$periodo_mes_estima_entrega <- ifelse(day(dfNum$dataEstimada) <= 5, "inicio do mês", ifelse(day(dfNum$dataEstimada) <= 23, "meio do mês", "fim do mês")) 

dfNum$periodo_ano_pedido <- ifelse(dfNum$mes_pedido <= 3, "1 Tri", ifelse(dfNum$mes_pedido <= 6, "2 Tri", ifelse(dfNum$mes_pedido <= 9, "3 Tri", "4 Tri"))) 
dfNum$periodo_ano_estima_entrega <- ifelse(dfNum$mes_estima_entrega <= 3, "1 Tri", ifelse(dfNum$mes_estima_entrega <= 6, "2 Tri", ifelse(dfNum$mes_estima_entrega <= 9, "3 Tri", "4 Tri"))) 

dfNum$diaSemana_pedido <- wday(dfNum$dataPedido)
dfNum$TipoDiaSemana_pedido <- ifelse(dfNum$diaSemana_pedido == 1 | dfNum$diaSemana_pedido == 7, "fim de semana", "dia util")

#reorganizaçao do df
dfNum <- subset(dfNum, select = c(1, 2, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 3))  

#Remove os NA - Observados em Volume, Peso, Distancia e Tempo de Entrega
dfNum <- dfNum %>% drop_na() #24 Observacoes com algum dado importante faltante - nao afetando em 99778 observacoes totais

#Remove valores de Frete menores que R$5,00 - Distancias maiores que as possiveis no brasil - pesos maiores que 0
dfNum <- dfNum %>% 
  filter(total_freight >= 5)

dfNum <- dfNum %>% 
  filter(dist > 0 & dist <= 4394000)

dfNum <- dfNum %>% 
  filter(product_weight_g > 0)
```

# Resumo

O comércio eletrônico no Brasil experimentou um crescimento significativo nas últimas décadas, tornando-se uma parte essencial do cenário de varejo do país. Com uma população numericamente grande e uma economia em crescimento, o Brasil viu um aumento notável nas transações de comércio eletrônico. Milhões de brasileiros agora preferem fazer compras online, aproveitando a conveniência de encontrar uma ampla variedade de produtos e serviços sem sair de casa. Plataformas de comércio eletrônico e marketplaces desempenham um papel fundamental nesse ecossistema, conectando consumidores a uma vasta gama de vendedores e produtos. 

Apesar dos desafios logísticos e de infraestrutura, o comércio eletrônico no Brasil continua a atrair investimentos e inovações. A base de dados "Brazilian E-Commerce Public Dataset by Olist" oferece insights valiosos sobre as transações e comportamento dos consumidores nesse mercado em constante evolução, permitindo análises detalhadas e tomada de decisões informadas. 

A fim de entender melhor o comportamento do comércio eletrônico, o trabalho contempla análise com métodos estatísticos explicados na disciplina Regressão Linear, tais como análise descritiva de dados, análise de multicolineareida, entendimentos de valores influentes, verificação de parâmetros da tabela ANOVA, aplicação de teste de hipoteses como Kolmogorov-Smirnov, Breush-Pagan e seleção de modelos, na base de dados da Olist a fim de entender como se relaciona o preço do frete em decorrência de variáveis como tamanho e peso do produto entregue, distância entre compradores e vendedores, data da entrega, dentre outras. 

# Introdução

A análise preditiva desempenha um papel crucial na gestão eficaz das operações de comércio eletrônico, especialmente no que diz respeito ao cálculo de frete. A fim de entender melhor o comércio eletrônico brasileiro, foi encontrada a  base de dados "Brazilian E-Commerce Public Dataset by Olist" que permite explorar e entender as complexas variáveis que influenciam o custo de frete no contexto do comércio eletrônico no Brasil. 

Sendo o frete é um dos principais fatores que impactam a experiência do cliente e os custos operacionais das empresas de comércio eletrônico. Torna-se aprazível buscar calcular da maneira objetiva o custo do frete envolvendo várias variáveis interconectadas, como a quantidade de produtos entregues, o valor do pedido do produto, o volume do pedido, a distância da entrega, a quantidade de dias para entregar o produto e o peso do produto. 

Nesse cenário complexo, a regressão linear surge como uma ferramenta para prever os custos de frete com base nessas variáveis. Através da análise preditiva, podemos tentar explorar as relações entre essas variáveis e os custos de frete, identificando tendências e padrões que podem ajudar a tomada de decisões mais clarividentes. 

Através da análise de dados da base: "Brazilian E-Commerce Public Dataset by Olist", é possível entender e justificar a aplicação da análise preditiva por regressão linear a fim de estimar os custos de frete no contexto do comércio eletrônico brasileiro. Com essas estimativas pretende-se fornecer insights valiosos que buscam otimizar processos logísticos, melhorando a satisfação do cliente para que haja a tomada de decisões estratégicas baseadas em dados sólidos. 

Durante o curso deste trabalho, iremos analisar cuidadosamente as variáveis disponíveis na base de dados, construir modelos de regressão linear e avaliar sua eficácia na previsão dos custos de frete. Além disso, discutiremos como essa análise pode contribuir para a redução de custos operacionais e a otimização das operações de entrega. 

# Materiais e Métodos
## Desenho do Estudo
Neste capítulo, detalharemos os materiais e métodos utilizados para desenvolver e analisar nosso modelo de regressão linear múltipla. O objetivo deste estudo é investigar as variáveis que influenciam o valor do frete a ser pago em um e-commerce brasileiro, considerando dados de pedidos realizados entre 2016 e 2018, com uma amostra de cerca de 100.000 pedidos. 

## Coleta de Dados
### Fonte de Dados 
Os dados para este estudo foram obtidos do banco de dados de um market place brasileiro, que registra informações detalhadas sobre pedidos realizados entre 2016 e 2018, e disponibilizado na plataforma kaggle para fins de análise pública, através do link:https://www.kaggle.com/datasets/olistbr/brazilian-ecommerce. A fonte de dados foi selecionada devido à sua relevância, para os autores, por se tratar de um problema real, próximo da realidade profissional vivenciadas por eles, devido ao tamanho da base de dados, além de relevante para comunidade ter o entendimento dos fatores que afetam o valor do frete em transações online e uma projeção do quanto pagaria. 


![Figura 1: Esquemático relacional entre as bases de dados utilizada. Disponível em: https://www.kaggle.com/datasets/olistbr/brazilian-ecommerce](/Users/victortelles/Documents/Coursera/Especializacao - UFMG/04 - Modelagem de relacoes usando Regressao Linear/Trabalho/HRhd2Y0.png)

Descrição das bases de dados quem compõem o sistema da Figura 1: 

- Pedidos (Orders): Informações sobre os pedidos feitos pelos clientes, incluindo data do pedido, identificação do pedido, status do pedido e identificação do cliente. 
- Itens de Pedido (Order Items): Detalhes sobre os itens individuais dentro de cada pedido, incluindo identificação do produto, preço, quantidade, e o valor total do item. 
- Produtos (Products): Informações sobre os produtos disponíveis para compra, incluindo nome do produto, categoria, preço e peso. 
- Clientes (Customers): Dados sobre os clientes que fizeram os pedidos, incluindo identificação do cliente, nome, cidade e estado. 
- Pagamentos (Payments): Detalhes sobre os pagamentos associados a cada pedido, incluindo método de pagamento, valor do pagamento e parcelamento, quando aplicável. 
- Vendedores (Sellers): Informações sobre os vendedores que forneceram os produtos, incluindo identificação do vendedor, nome, cidade e estado. 
- Avaliações (Reviews): Avaliações e classificações dadas pelos clientes aos produtos e ao serviço de entrega. 
- Geolocalização (Geolocation): Dados de geolocalização que relacionam códigos postais às regiões geográficas no Brasil. 
- Categorias de Produtos (Product Categories): Informações sobre as categorias às quais os produtos pertencem. 

### Amostragem
Foram utilizados todos os pedidos observados no banco de dados, desde que tivesse sido "entregue", não possuisse variáveis nulas ao fazer as combinações com as demais bases de dados, o peso do produto fosse maior que zero, o volume do produto fosse maior que zero, a distância entre vendedor e comprador fosse maior que zero e menor que a maior distancia em linha reta do Brasil (4.394 km), pedido que cujo pagamento não tivesse utilização de voucher. Com aplicação de todas estas restrições foram obtidas 94.995 observações para compor o modelo.

### Variáveis
As variáveis utilizadas neste estudo incluem: 

Variável Dependente (Y): Valor do Frete - Esta é a variável que pretendemos prever com base nas variáveis independentes. 

Variáveis Independentes (X1, X2, X3, ...): As variáveis explicativas incluem: 
- Caracteristicas do Pedido (por exemplo, valor total, quantidade de itens)

- Características do Produto (Peso, volume). 

- Características do Cliente (por exemplo, cep, latitude e longitude). 

- Características do Vendedor (por exemplo, cidade, localização). 

- Distância entre CEPs do Cliente e do Vendedor. 

- Características de tempo (por exemplo, dia da semana da compra, época do ano). 

## Modelagem Estatística
### Modelo de Regressão Linear Múltipla

Para realizar a análise, utilizamos um modelo de regressão linear múltipla. buscando encontrar uma equação para o modelo como a seguinte:
Frete = β0 + β1X1 + β2X2 + ... + βnXn + ε 

Onde: 

Frete é o valor do frete. 

- X1 ,X2 ,…,Xn  representam as variáveis explicativas mencionadas anteriormente. 
- β0  é o intercepto. 
- β1 ,β2 ,…,βn  são os coeficientes de regressão das variáveis independentes. 
- ε é o termo de erro

Neste estudo, foi aplicado o método stepwise para seleção de variáveis no modelo. O método stepwise nos permitiu avaliar e selecionar automaticamente as variáveis independentes mais relevantes com base em critérios estatísticos, incluindo o critério BIC (Bayesian Information Criterion). O critério BIC é particularmente útil, pois considera tanto a qualidade de ajuste do modelo quanto a complexidade, ajudando a evitar a inclusão de variáveis desnecessárias e, assim, melhorar a generalização do modelo.

Além disso, foi conduzida uma análise de multicolinearidade entre as variáveis independentes. A multicolinearidade ocorre quando duas ou mais variáveis independentes estão altamente correlacionadas, o que pode prejudicar a interpretação dos coeficientes e a estabilidade do modelo. Durante a análise, identificamos e tratamos a multicolinearidade, quando necessário, para garantir que as variáveis independentes fossem independentes umas das outras.

Adicionalmente, foi realizada uma análise de interação entre variáveis do tipo categóricas (como período do ano da entrega) e variáveis numéricas (Distância entre CEPs). Isso nos permitiu explorar se as relações entre essas variáveis eram afetadas por fatores adicionais, como o tipo de cliente ou a distância geográfica. A inclusão de termos de interação no modelo nos ajudou a capturar essas complexas relações.

Esta abordagem abrangente de seleção de variáveis, análise de multicolinearidade e consideração de interações entre variáveis contribuiu para a construção de um modelo de regressão linear múltipla mais preciso e interpretável, permitindo uma análise mais aprofundada dos determinantes do valor do frete em nosso e-commerce brasileiro.

### Pré-processamento de Dados
Antes de ajustar o modelo de regressão linear múltipla, realizamos um rigoroso pré-processamento dos dados para garantir a qualidade e a integridade das informações.

- Tratamento de Dados Ausentes: Inicialmente, identificamos e tratamos dados ausentes em todas as variáveis. Isso envolveu a remoção de observações com valores ausentes ou preenchimento desses valores com técnicas apropriadas, como média ou mediana, quando aplicável.

- Cálculo da Distância entre CEPs: Para incorporar a distância entre o vendedor e o comprador como uma variável independente no modelo, calculamos a distância geodésica entre dois pontos globais usando suas coordenadas de latitude e longitude. Isso nos permitiu quantificar a distância física entre o vendedor e o comprador para análise.

- Agregação de Bases de Dados:

-  Geolocalização: Para incorporar informações geográficas relevantes, agregamos a base de dados de Geolocalização, calculando a latitude e a longitude média de cada CEP. Isso nos forneceu coordenadas geográficas mais precisas para análise.
-  OrdersItems: Agregamos a base de dados OrdersItems somando a quantidade de itens por pedido. Isso nos permitiu considerar o volume total de itens em cada pedido como uma variável independente no modelo.

O pré-processamento de dados foi uma etapa crítica para garantir que os dados fossem adequados para a modelagem de regressão e que as informações importantes fossem devidamente incorporadas. Essas transformações e agregações forneceram uma base sólida para a análise estatística e a construção do modelo de regressão linear múltipla.


### Software e Pacotes
Para conduzir a análise estatística e a construção do modelo de regressão linear múltipla, utilizamos a linguagem de programação R juntamente com o ambiente de desenvolvimento integrado RStudio. Essas ferramentas forneceram uma plataforma robusta para a análise de dados e modelagem estatística.

Além disso, foram empregados diversos pacotes de R para realizar tarefas específicas, incluindo, mas não se limitando a:

- car: Utilizado para realizar testes de multicolinearidade, bem como outras análises estatísticas.
- rgl: Usado para visualizações tridimensionais, quando necessário.
- leaps: Utilizado para realizar a seleção de variáveis com base em critérios como BIC, parte do método stepwise.
- lmtest: Possibilitou a realização de testes de hipóteses relacionados ao modelo de regressão linear múltipla.
- olsrr: Forneceu uma série de funções úteis para a análise de regressão, incluindo diagnósticos de resíduos e medidas de ajuste do modelo.
- dplyr: Facilitou a manipulação e transformação eficiente de dados.
- ggplot2: Utilizado para criar visualizações gráficas de alta qualidade.
- lubridate: Auxiliou no trabalho com datas e horários, como a análise de época do ano.
- geosphere: Usado para calcular distâncias geodésicas entre coordenadas de latitude e longitude.
- tidyverse: Uma coleção abrangente de pacotes para manipulação de dados, visualização e modelagem estatística.
- corrplot: Utilizado para criar gráficos de matriz de correlação.
- nortest: Usado para realizar testes de normalidade nos resíduos do modelo.

Esses pacotes desempenharam papéis cruciais ao longo da análise, desde a exploração inicial dos dados até a construção e avaliação do modelo de regressão linear múltipla. A escolha dessas ferramentas e pacotes específicos contribuiu para uma análise eficiente e completa dos dados do e-commerce brasileiro.

# Análises e Resultados
## Análise Exploratória de Dados
Nesta seção, foi feita uma análise exploratória das variáveis numéricas que compõem o conjunto de dados. Essa etapa é fundamental para compreender a distribuição das variáveis e suas relações com a variável resposta, o valor do frete.

### Variável qty_product
- Medidas de Posição: A média da quantidade de produtos (qty_product) foi de [valor médio], com um desvio padrão de [valor do desvio padrão], indicando [indicar se é uma dispersão alta ou baixa].
```{r chunk1, echo=T}
summary(dfNum$qty_product) #Medidas de Posicao #Q3 - Em um produto
sd(dfNum$qty_product)   
```
- Histograma: O histograma da variável qty_product mostra uma distribuição [descrever a forma da distribuição  assimétrica].
```{r chunk2, echo=TRUE}
hist(dfNum$qty_product)    #Histograma - Observa-se que a imensa maioria dos pedidos tem um produto apenas
```
- Box Plot: O box plot revela a presença de [indicar a presença de outliers ou a assimetria da distribuição, se aplicável].
```{r chunk3, echo=T}
boxplot(dfNum$qty_product) #Box-plot - ratifica o ponto acima
```
- Correlação de Pearson: A correlação de Pearson entre qty_product e total_freight foi de [valor da correlação], indicando [indicar o grau de correlação e direção, se positiva ou negativa].
```{r chunk4, echo=T}
with(dfNum, cor(qty_product, total_freight, method="pearson")) #[1] 0.3500383
```

### Variável total_price
- Medidas de Posição: O valor médio total_price foi de [valor médio], com um desvio padrão de [valor do desvio padrão].
```{r chunk5, echo=T}
summary(dfNum$total_price) #Medidas de Posicao - Existe valores de pedidos muito alto - 13400 reais - uma observacao - valor quase o dobro da segunda maior
sd(dfNum$total_price)      #Desvio-padrao [1] 203.787
```
- Histograma: O histograma da variável total_price sugere uma distribuição [descrever a forma da distribuição].
```{r chunk6, echo=T}
hist(dfNum$total_price)    #Histograma
```
- Box Plot: O box plot não revelou [indicar a presença de outliers ou a assimetria da distribuição, se aplicável].
```{r chunk7, echo=T}
boxplot(dfNum$total_price) #Box-plot  
```
- Correlação de Pearson: A correlação de Pearson entre total_price e total_freight foi de [valor da correlação].
```{r chunk8, echo=T}
with(dfNum, cor(total_price, total_freight, method="pearson")) #[1] 0.4074545  
```

### Variável volume
- Medidas de Posição: O valor médio do volume foi de [valor médio], com um desvio padrão de [valor do desvio padrão].
```{r chunk9, echo=T}
summary(dfNum$volume) #Medidas de Posicao
sd(dfNum$volume)      #Desvio-padrao [1] 23267.38 - alta dispersao
```
- Histograma: O histograma da variável volume indica [descrever a forma da distribuição].
```{r chunk10, echo=T}
hist(dfNum$volume)    #Histograma     
```
- Box Plot: O box plot [indicar se há outliers ou assimetria na distribuição].
```{r chunk11, echo=T}
boxplot(dfNum$volume) #Box-plot 
```
- Correlação de Pearson: A correlação de Pearson entre volume e total_freight foi de [valor da correlação].
```{r chunk12, echo=T}
with(dfNum, cor(volume, total_freight, method="pearson")) #0.4998182
```

### Variável dist (distância entre CEPs)
- Medidas de Posição: A média da distância entre CEPs foi de [valor médio], com um desvio padrão de [valor do desvio padrão].
```{r chunk13, echo=T}
summary(dfNum$dist) #Medidas de Posicao 
sd(dfNum$dist)      #Desvio-padrao [1] 592318.2 - alta dispersao
```
- Histograma: O histograma da variável dist [descrever a forma da distribuição].
```{r chunk14, echo=T}
hist(dfNum$dist)    #Histograma 
```
- Box Plot: O box plot [indicar se há outliers ou assimetria na distribuição].
```{r chunk15, echo=T}
boxplot(dfNum$dist) #Box-plot - cerca de 4 observacoes muito distantes - mais de 8mil km de distancia - muito superior a distancia do brasil - Excluir observacoes
```
- Correlação de Pearson: A correlação de Pearson entre dist e total_freight foi de [valor da correlação].
```{r chunk16, echo=T}
with(dfNum, cor(dist, total_freight, method="pearson")) #0.3259257
```

### Variável tempoEntregaNum (tempo de entrega em dias)
- Medidas de Posição: O valor médio do tempoEntregaNum foi de [valor médio], com um desvio padrão de [valor do desvio padrão].
```{r chunk17, echo=T}
summary(dfNum$tempoEntregaNum) #Medidas de Posicao #Atencao para casos com mais de 120 dias de tempo de entrega - o estimado é 50 dias 
sd(dfNum$tempoEntregaNum)      #Desvio-padrao [1] 9.524263
```
- Histograma: O histograma da variável tempoEntregaNum [descrever a forma da distribuição].
```{r chunk18, echo=T}
hist(dfNum$tempoEntregaNum)    #Histograma
```
- Box Plot: O box plot [indicar se há outliers ou assimetria na distribuição].
```{r chunk19, echo=T}
boxplot(dfNum$tempoEntregaNum) #Box-plot
```
- Correlação de Pearson: A correlação de Pearson entre tempoEntregaNum e total_freight foi de [valor da correlação].
```{r chunk20, echo=T}
with(dfNum, cor(tempoEntregaNum, total_freight, method="pearson")) #0.1785367   
```

### Variável product_weight_g (peso do produto em gramas)
- Medidas de Posição: O valor médio do product_weight_g foi de [valor médio], com um desvio padrão de [valor do desvio padrão].
```{r chunk21, echo=T}
summary(dfNum$product_weight_g) #Medidas de Posicao
sd(dfNum$product_weight_g)     
```
- Histograma: O histograma da variável product_weight_g [descrever a forma da distribuição].
```{r chunk22, echo=T}
hist(dfNum$product_weight_g)    #Histograma - concentracao alta em produtos com ate 2kgs
```
- Box Plot: O box plot [indicar se há outliers ou assimetria na distribuição].
```{r chunk23, echo=T}
boxplot(dfNum$product_weight_g) #Box-plot existe um produto com mais de 40kg - atencao - produtos com 0 e 2g - estes tem erro na coleta de dados
```
- Correlação de Pearson: A correlação de Pearson entre product_weight_g e total_freight foi de [valor da correlação].
```{r chunk24, echo=T}
with(dfNum, cor(product_weight_g, total_freight, method="pearson")) #0.5219245 
```


### Variável total_freight (Variável Resposta)
- Medidas de Posição: A média do valor do frete (total_freight) foi de [valor médio], com um desvio padrão de [valor do desvio padrão].
```{r chunk25, echo=T}
summary(dfNum$total_freight)
sd(dfNum$total_freight) 
```
- Histograma: O histograma da variável total_freight [descrever a forma da distribuição].
```{r chunk26, echo=T}
hist(dfNum$total_freight) 
```
- Box Plot: O box plot [indicar se há outliers ou assimetria na distribuição].
```{r chunk27, echo=T}
boxplot(dfNum$total_freight)
```

### Correlação de Pearson entre Variáveis Explicativas e a Variável Resposta
Realizamos análises de correlação de Pearson individual entre cada uma das variáveis explicativas (qty_product, total_price, volume, dist, tempoEntregaNum, product_weight_g) e a variável resposta (total_freight). As correlações variaram de 0.178 a 0.522 e apresentaram correlações fracas ou moderadas com direção positiva, em todas as variaveis numericas testadas.

Essa análise exploratória de dados nos forneceu uma compreensão inicial das distribuições das variáveis, identificou possíveis outliers e nos permitiu avaliar a correlação entre as variáveis explicativas e a variável resposta, o que será fundamental para a construção e interpretação do modelo de regressão linear múltipla.

### Análise de Interação entre Variáveis

Para investigar a possível interação entre as variáveis dist, total_price, volume e o fator periodo_ano_estima_entrega, realizamos uma análise de interação. Isso nos permitiu examinar se o efeito de uma variável numérica no valor do frete é modificado ou dependente do nível do fator de período do ano estimado de entrega.

- Primeiro, examinamos a interação entre a distância entre CEPs (variável dist) e o fator periodo_ano_estima_entrega. Para isso, criamos gráficos de dispersão separados para cada nível do fator de período e colorimos os pontos de acordo com a distância entre CEPs. Isso nos permitiu visualizar se a relação entre a distância e o valor do frete variava entre os períodos do ano estimado de entrega. Neste gráfico vê-se as linhas que representam os trimestres todas sobrepostas, concluindo então que não há interação entre as variáveis dist (distancia entre cep do comprador e vendedor) e a epoca do ano que se estima entregar o produto.

```{r chunk111, echo=T, include=FALSE}
ggplot(dfNum, aes(x = dist, y = total_freight, color=periodo_ano_estima_entrega)) +    #Plota grafico
  geom_point(size=2, shape=16) +                           #Muda padrao dos pontos  
  scale_color_manual(values=c("violetred", "royalblue", "green", "yellow")) +  #Muda cores
  geom_smooth(method = "lm", se=FALSE)#Coloca linhas - Nota-se uma interacao entre Volume e o periodo do ano que a entrega é feita
```

- Da mesma forma, realizamos uma análise de interação entre o preço total (variável total_price) e o fator periodo_ano_estima_entrega. Novamente, criamos gráficos de dispersão para cada nível do fator de período e colorimos os pontos de acordo com o preço total. Isso nos permitiu avaliar se a relação entre o preço total e o valor do frete variava em diferentes períodos do ano estimado de entrega. Já para a variável explicativa que representa o preço total (total_price), as linhas que represetam os trimestres tem inclinacoes diferentes, deste modo indica que há uma interação a ser considerada no modelo de regressão. Por exemplo, vemos que no terceiro trimestre os valores dos pedidos são mais caros que nos periodos anteriores.

```{r chunk1111, echo=T}
ggplot(dfNum, aes(x = total_price, y = total_freight, color=periodo_ano_estima_entrega)) +    #Plota grafico
  geom_point(size=2, shape=16) +                           #Muda padrao dos pontos  
  scale_color_manual(values=c("violetred", "royalblue", "green", "yellow")) +  #Muda cores
  geom_smooth(method = "lm", se=FALSE)#Coloca linhas - Nota-se uma interacao entre Volume e o periodo do ano que a entrega é feita
```

- A análise de interação também foi conduzida para a variável volume e o fator periodo_ano_estima_entrega. Utilizamos gráficos de dispersão para representar a relação entre o volume e o valor do frete, segmentados por níveis do fator de período. A coloração dos pontos foi baseada nos valores de volume. Ao analisar a variavel volume interagindo com periodo esperado para entrega, observa-se que alguns trimestres tem inclinações diferentes, que é o caso do terceiro e quarto, com maiores tamanhos volumétricos de pedidos, com o primeiro e segundo trimestre sendo compras de menor tamanho físico. E novamente, estas inclinações diferentes indicam que precisam ser testadas na modelagem estatística 

```{r chunk122, echo=T}
ggplot(dfNum, aes(x = volume, y = total_freight, color=periodo_ano_estima_entrega)) +    #Plota grafico
  geom_point(size=2, shape=16) +                           #Muda padrao dos pontos  
  scale_color_manual(values=c("violetred", "royalblue", "green", "yellow")) +  #Muda cores
  geom_smooth(method = "lm", se=FALSE)#Coloca linhas - Nota-se uma interacao entre Volume e o periodo do ano que a entrega é feita
```

Essa análise de interação entre as variáveis numéricas (dist, total_price, volume) e o fator periodo_ano_estima_entrega nos permitiu compreender melhor como essas variáveis podem influenciar de forma conjunta o valor do frete em diferentes momentos do ano estimado de entrega. Esses insights serão úteis para a construção de modelos de regressão mais precisos e para a interpretação dos resultados finais. Trazendo a necessidade de testar no modelo a interação entre total_price e volume com a variável (fator) periodo_ano_estima_entrega.

## Elaboração do Modelo de Regressão

Para analisar os determinantes do valor do frete em nosso e-commerce brasileiro, realizamos uma modelagem de regressão linear múltipla. Utilizamos a linguagem de programação R com a função lm() para construir o modelo. A fórmula utilizada para o modelo foi a seguinte:

[lm(total_freight ~ product_weight_g + volume + dist + tempoEntregaNum + qty_product + total_price + factor(periodo_ano_estima_entrega) + volume:factor(periodo_ano_estima_entrega) + total_price:factor(periodo_ano_estima_entrega), data = dfNum)]

Nesta fórmula, total_freight é a variável dependente que estamos tentando prever, enquanto as outras variáveis são as variáveis independentes que consideramos relevantes com base na análise exploratória de dados. Vamos explicar cada parte da fórmula:

product_weight_g, volume, dist, tempoEntregaNum, qty_product e total_price são as variáveis numéricas que incluímos como preditores no modelo.

factor(periodo_ano_estima_entrega) representa o fator categórico que indica o período do ano estimado de entrega. Ele foi incluído no modelo para capturar as possíveis variações sazonais nas relações entre as variáveis independentes e a variável dependente.

As interações entre variáveis foram modeladas com volume:factor(periodo_ano_estima_entrega) e total_price:factor(periodo_ano_estima_entrega). Isso permite que o efeito das variáveis numéricas (volume e total_price) no valor do frete varie de acordo com o período do ano estimado de entrega.

Ao ajustar o modelo de regressão linear múltipla, consideramos a significância estatística dos coeficientes, a multicolinearidade entre as variáveis independentes e realizamos testes de hipóteses para avaliar a qualidade do ajuste do modelo.

### Resultados da Modelagem
Os resultados da modelagem de regressão linear forneceram importantes insights sobre os determinantes do valor do frete em nosso e-commerce brasileiro. Alguns dos principais resultados incluem:

Efeito das Variáveis Numéricas: As variáveis numéricas, como o peso do produto (product_weight_g), o volume e o preço total, mostraram-se estatisticamente significativas na previsão do valor do frete. Isso sugere que aumentos nessas variáveis estão associados a aumentos ou diminuições no valor do frete, dependendo de suas direções de efeito.

Efeito do Período do Ano Estimado de Entrega: A inclusão do fator categórico do período do ano estimado de entrega revelou variações sazonais nas relações entre as variáveis independentes e o valor do frete. Isso indica que o período do ano pode influenciar a dinâmica dos custos de frete.

Interações Significativas: As interações entre as variáveis numéricas (volume e preço total) e o fator do período do ano estimado de entrega foram estatisticamente significativas. Isso significa que o efeito dessas variáveis na determinação do valor do frete pode variar sazonalmente.

Esses resultados são fundamentais para entender como as características dos produtos, as distâncias entre CEPs, os tempos de entrega e os preços afetam o valor do frete em nosso e-commerce brasileiro. Eles também fornecem informações valiosas para a tomada de decisões e estratégias de preços sazonais. A seguir, apresentaremos uma interpretação mais detalhada dos coeficientes e medidas de ajuste do modelo.

A seleção de variáveis é uma etapa crítica na construção de um modelo de regressão linear múltipla. O objetivo é identificar quais variáveis independentes são mais relevantes para prever a variável dependente, neste caso, o valor do frete (total_freight). Para realizar essa seleção de forma sistemática, utilizamos o método stepwise com o critério BIC.

foi usada a formula step(modelo_num, direction = 'both',  k = log(n)) e com isto obtido o seguinte modelo:
![Figura 2: Resultado do Modelo 1](/Users/victortelles/Documents/Coursera/Especializacao - UFMG/04 - Modelagem de relacoes usando Regressao Linear/Trabalho/modelo1.png)
No modelo 1, o R2 ajustado foi de 0.5618, e o termo do erro (sigma2) 185.2557.
Fazendo a analise de VIF, não são observadas variaveis que tenham valor acima do treshold definido (5). Ou seja, pode-se continuar com todas as variáveis definidas. Observando o teste t, ao usar o comando summary(modelo1), ve-se que todas as variaveis tem p-valor abaixo de 5%, ou seja, devem fazer parte do modelo.
![Figura 3: summary(modelo1)](/Users/victortelles/Documents/Coursera/Especializacao - UFMG/04 - Modelagem de relacoes usando Regressao Linear/Trabalho/sum_modelo1.png)
Analise de Residuosa